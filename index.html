<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Multi-Coda</title>
  <script src="https://cdn.tailwindcss.com"></script><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB0Jiquu-w8S7UQi3irpXLQ-fdM_FxC7XQ",
            authDomain: "gestione-coda.firebaseapp.com",
            databaseURL: "https://gestione-coda-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gestione-coda",
            storageBucket: "gestione-coda.firebasestorage.app",
            messagingSenderId: "140779823782",
            appId: "1:140779823782:web:43ac93e7f2957ffbf1ca67"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseDb = getDatabase(app);
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseGet = get;
        window.firebaseInitialized = true;
        
        console.log('üî• Firebase inizializzato con successo!');
    </script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            }
            50% { 
                transform: scale(1.05); 
                box-shadow: 0 0 40px rgba(59, 130, 246, 0.8);
            }
        }
        
        .number-display {
            font-size: 12rem;
            line-height: 1;
            text-shadow: 0 0 30px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .number-display {
                font-size: 8rem;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-slate-900 to-blue-900 min-h-screen"><!-- Selettore Modalit√† -->
  <div class="fixed top-4 right-4 z-50"><select id="modeSelector" onchange="switchMode()" class="bg-white/90 backdrop-blur-sm border border-gray-300 rounded-lg px-4 py-2 text-sm font-medium shadow-lg"> <option value="display">üì∫ Display Pubblico</option> <option value="controls">üéõÔ∏è Controlli</option> <option value="status">üìä Stato Sistema</option> <option value="overview">üóÇÔ∏è Panoramica Code</option> </select>
  </div><!-- Indicatore Sincronizzazione -->
  <div id="syncIndicator" class="fixed top-4 left-4 z-50">
   <div class="bg-yellow-500/90 backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm font-medium">
    ‚öôÔ∏è Inizializzazione Firebase...
   </div>
  </div><!-- Sistema Notifiche -->
  <div id="notificationContainer" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- MODALIT√Ä DISPLAY PUBBLICO -->
  <div id="displayMode" class="min-h-screen flex flex-col items-center justify-center bg-white">
   <div class="text-center px-4">
    <div id="currentNumberDisplay">
     <div id="displayCurrentNumber" class="number-display font-black text-gray-900">
      --
     </div>
    </div>
   </div>
  </div><!-- MODALIT√Ä CONTROLLI -->
  <div id="controlsMode" class="min-h-screen p-4 flex flex-col hidden">
   <div class="text-center mb-6" style="display: none;">
    <div class="mb-4"><select id="controlsQueueSelector" onchange="switchQueueFromControls()" class="bg-white/90 backdrop-blur-sm border border-gray-300 rounded-lg px-6 py-3 text-base font-medium shadow-lg"> <option value="sportello1">üîµ Sportello 1</option> <option value="sportello2">üü¢ Sportello 2</option> <option value="sportello3">üü° Sportello 3</option> <option value="sportello4">üî¥ Sportello 4</option> <option value="sportello5">üü£ Sportello 5</option> </select>
    </div>
    <h1 id="controlsQueueName" class="text-4xl font-black text-white mb-2">SPORTELLO 1</h1>
    <div id="controlsQueueIcon" class="text-6xl">
     üîµ
    </div>
   </div>
   <div class="flex-1 flex items-center justify-center">
    <div class="w-full max-w-6xl"><!-- Due pulsanti principali -->
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button onclick="callNext()" id="controlsCallNextBtn" class="bg-green-600 hover:bg-green-700 text-white py-20 rounded-3xl font-black text-5xl transition-all shadow-2xl"> üì¢ CHIAMA<br>
       PROSSIMO </button> <button onclick="goBackOne()" class="bg-red-600 hover:bg-red-700 text-white py-20 rounded-3xl font-black text-5xl transition-all shadow-2xl"> ‚¨ÖÔ∏è TORNA<br>
       INDIETRO </button>
     </div>
    </div>
   </div><!-- Pulsanti inferiori -->
   <div class="w-full max-w-6xl mx-auto pb-4">
    <div class="bg-yellow-600 rounded-2xl p-6 mb-4">
     <h3 class="text-white font-bold text-2xl mb-3 text-center">üéØ CHIAMA NUMERO SPECIFICO</h3>
     <div class="flex gap-3"><input type="number" id="specificNumber" placeholder="Numero..." min="1" class="flex-1 px-6 py-4 bg-white/20 border-2 border-white/30 rounded-xl text-white placeholder-white/70 text-2xl font-bold text-center"> <button onclick="callSpecificNumber()" class="bg-white/20 hover:bg-white/30 text-white px-12 py-4 rounded-xl font-bold text-2xl border-2 border-white/30 transition-all"> CHIAMA </button>
     </div>
    </div><button onclick="resetCurrentQueue()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-6 rounded-2xl font-black text-2xl transition-all shadow-2xl"> üîÑ RESET CODA CORRENTE </button>
   </div>
  </div><!-- MODALIT√Ä STATO SISTEMA -->
  <div id="statusMode" class="min-h-screen p-4 hidden">
   <div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
     <div class="mb-4"><select id="queueSelector" onchange="switchQueue()" class="bg-white/90 backdrop-blur-sm border border-gray-300 rounded-lg px-6 py-3 text-base font-medium shadow-lg"> <option value="sportello1">üîµ Sportello 1</option> <option value="sportello2">üü¢ Sportello 2</option> <option value="sportello3">üü° Sportello 3</option> <option value="sportello4">üî¥ Sportello 4</option> <option value="sportello5">üü£ Sportello 5</option> </select>
     </div>
     <h1 id="statusQueueName" class="text-4xl font-bold text-white mb-2">SPORTELLO 1</h1>
     <div id="statusQueueIcon" class="text-6xl">
      üîµ
     </div>
     <p class="text-blue-200 mt-2">Stato dettagliato della coda</p>
    </div>
    <div class="grid md:grid-cols-2 gap-6">
     <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6">
      <h2 class="text-2xl font-semibold text-white mb-6">üìä Statistiche</h2>
      <div class="space-y-4">
       <div class="bg-blue-500/20 rounded-lg p-4">
        <div class="flex justify-between items-center"><span class="text-blue-200">Persone in Coda</span> <span class="text-2xl font-bold text-blue-300" id="statusTotalInQueue">99</span>
        </div>
       </div>
       <div class="bg-green-500/20 rounded-lg p-4">
        <div class="flex justify-between items-center"><span class="text-green-200">Persone Servite</span> <span class="text-2xl font-bold text-green-300" id="statusTotalServed">0</span>
        </div>
       </div>
       <div class="bg-yellow-500/20 rounded-lg p-4">
        <div class="flex justify-between items-center"><span class="text-yellow-200">Tempo Stimato</span> <span class="text-xl font-bold text-yellow-300" id="statusEstimatedWait">~5h</span>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6">
      <h2 class="text-2xl font-semibold text-white mb-6">üéØ Stato Corrente</h2>
      <div class="mb-6">
       <h3 class="text-lg font-medium text-blue-200 mb-3">üîî In Servizio</h3>
       <div id="statusCurrentCustomer" class="bg-yellow-500/20 border-2 border-yellow-400/50 rounded-lg p-6 text-center">
        <div class="text-white/70">
         Nessun numero chiamato
        </div>
       </div>
      </div>
      <div>
       <h3 class="text-lg font-medium text-blue-200 mb-3">‚è≠Ô∏è Prossimo in Coda</h3>
       <div class="bg-blue-500/20 border-2 border-blue-400/50 rounded-lg p-6 text-center">
        <div class="text-3xl font-bold text-blue-300" id="statusNextNumberValue">
         1
        </div>
       </div>
      </div>
     </div>
    </div>
    <div class="mt-6 bg-white/10 backdrop-blur-sm rounded-2xl p-6">
     <h2 class="text-2xl font-semibold text-white mb-4">üìù Cronologia Recente</h2>
     <div id="statusHistoryList" class="space-y-2 max-h-48 overflow-y-auto"></div>
    </div>
   </div>
  </div><!-- MODALIT√Ä PANORAMICA CODE -->
  <div id="overviewMode" class="min-h-screen p-4 hidden">
   <div class="max-w-7xl mx-auto">
    <div class="text-center mb-8">
     <h1 class="text-4xl font-bold text-white mb-2">üóÇÔ∏è Panoramica Tutte le Code</h1>
     <p class="text-blue-200">Stato in tempo reale di tutti gli sportelli</p>
    </div>
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="overviewGrid"><!-- Le card saranno generate dinamicamente -->
    </div>
    <div class="mt-8 bg-white/10 backdrop-blur-sm rounded-2xl p-6">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold text-white">‚öôÔ∏è Gestione Sistema</h2><button onclick="resetAllQueues()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition-all"> üîÑ RESET TUTTE LE CODE </button>
     </div>
     <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-blue-500/20 rounded-lg p-4 text-center">
       <div class="text-3xl font-bold text-blue-300" id="overviewTotalWaiting">
        0
       </div>
       <div class="text-sm text-blue-200">
        Totale in Attesa
       </div>
      </div>
      <div class="bg-green-500/20 rounded-lg p-4 text-center">
       <div class="text-3xl font-bold text-green-300" id="overviewTotalServed">
        0
       </div>
       <div class="text-sm text-green-200">
        Totale Serviti
       </div>
      </div>
      <div class="bg-purple-500/20 rounded-lg p-4 text-center">
       <div class="text-3xl font-bold text-purple-300" id="overviewActiveQueues">
        5
       </div>
       <div class="text-sm text-purple-200">
        Code Attive
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configurazione code
        const QUEUE_CONFIGS = {
            sportello1: { name: 'SPORTELLO 1', icon: 'üîµ', color: 'blue' },
            sportello2: { name: 'SPORTELLO 2', icon: 'üü¢', color: 'green' },
            sportello3: { name: 'SPORTELLO 3', icon: 'üü°', color: 'yellow' },
            sportello4: { name: 'SPORTELLO 4', icon: 'üî¥', color: 'red' },
            sportello5: { name: 'SPORTELLO 5', icon: 'üü£', color: 'purple' }
        };

        // Stato globale
        let allQueues = {};
        let currentQueueId = 'sportello1';
        let currentMode = 'display';
        let sessionId = generateSessionId();
        let isFirebaseReady = false;
        let firebaseListeners = {};

        // Inizializza tutte le code
        function initializeAllQueues() {
            Object.keys(QUEUE_CONFIGS).forEach(queueId => {
                allQueues[queueId] = {
                    queue: [],
                    currentCustomer: null,
                    totalServed: 0,
                    history: [],
                    lastUpdateTime: 0
                };
                
                // Inizializza coda 1-99
                for (let i = 1; i <= 99; i++) {
                    allQueues[queueId].queue.push({
                        number: i,
                        addedTime: new Date().toLocaleTimeString('it-IT')
                    });
                }
                
                allQueues[queueId].history.push({
                    action: `üîÑ ${QUEUE_CONFIGS[queueId].name} inizializzato - 99 persone in attesa`,
                    time: new Date().toLocaleTimeString('it-IT')
                });
            });
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showNotification(message, type = 'info') {
            // Non mostrare notifiche in modalit√† display pubblico
            if (currentMode === 'display') {
                return;
            }
            
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            let bgColor, icon;
            switch(type) {
                case 'success': bgColor = 'bg-green-500/90'; icon = '‚úÖ'; break;
                case 'error': bgColor = 'bg-red-500/90'; icon = '‚ùå'; break;
                case 'warning': bgColor = 'bg-yellow-500/90'; icon = '‚ö†Ô∏è'; break;
                default: bgColor = 'bg-blue-500/90'; icon = '‚ÑπÔ∏è';
            }
            
            notification.className = `${bgColor} backdrop-blur-sm text-white px-4 py-3 rounded-lg shadow-lg max-w-sm slide-up`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-lg">${icon}</span>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function updateSyncIndicator(text, color = 'blue') {
            const indicator = document.getElementById('syncIndicator');
            const colors = {
                blue: 'bg-blue-500/90',
                green: 'bg-green-500/90',
                yellow: 'bg-yellow-500/90',
                red: 'bg-red-500/90'
            };
            if (indicator) {
                indicator.innerHTML = `<div class="${colors[color]} backdrop-blur-sm text-white px-3 py-1 rounded-lg text-sm font-medium">${text}</div>`;
            }
        }

        // ========== FIREBASE REAL-TIME SYNC ==========

        async function initializeFirebase() {
            updateSyncIndicator('üîÑ Connessione a Firebase...', 'yellow');
            
            // Aspetta che Firebase sia caricato
            let attempts = 0;
            while (!window.firebaseInitialized && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.firebaseInitialized) {
                updateSyncIndicator('‚ùå Firebase non disponibile', 'red');
                showNotification('Errore connessione Firebase - Solo modalit√† locale', 'error');
                return;
            }
            
            try {
                // Carica i dati iniziali da Firebase
                await loadAllQueuesFromFirebase();
                
                // Setup listener real-time per ogni coda
                setupFirebaseListeners();
                
                isFirebaseReady = true;
                updateSyncIndicator('üî• Firebase Real-Time Attivo', 'green');
                showNotification('Sincronizzazione real-time attiva!', 'success');
                
            } catch (error) {
                console.error('Errore inizializzazione Firebase:', error);
                updateSyncIndicator('‚ö†Ô∏è Firebase errore', 'red');
                showNotification('Errore Firebase: ' + error.message, 'error');
            }
        }

        function setupFirebaseListeners() {
            Object.keys(QUEUE_CONFIGS).forEach(queueId => {
                const queueRef = window.firebaseRef(window.firebaseDb, `queues/${queueId}`);
                
                // Listener real-time
                const unsubscribe = window.firebaseOnValue(queueRef, (snapshot) => {
                    const data = snapshot.val();
                    
                    if (data && data.sessionId !== sessionId) {
                        // Aggiorna solo se da un'altra sessione
                        if (data.timestamp > allQueues[queueId].lastUpdateTime) {
                            allQueues[queueId] = {
                                queue: data.queue || [],
                                currentCustomer: data.currentCustomer || null,
                                totalServed: data.totalServed || 0,
                                history: data.history || [],
                                lastUpdateTime: data.timestamp
                            };
                            
                            updateDisplay();
                            
                            // Notifica cambio
                            if (queueId === currentQueueId && data.currentCustomer) {
                                showNotification(
                                    `${QUEUE_CONFIGS[queueId].icon} Numero ${data.currentCustomer.number} chiamato da altro dispositivo`, 
                                    'info'
                                );
                            }
                        }
                    }
                });
                
                firebaseListeners[queueId] = unsubscribe;
            });
        }

        async function loadAllQueuesFromFirebase() {
            for (const queueId of Object.keys(QUEUE_CONFIGS)) {
                try {
                    const queueRef = window.firebaseRef(window.firebaseDb, `queues/${queueId}`);
                    const snapshot = await window.firebaseGet(queueRef);
                    const data = snapshot.val();
                    
                    if (data) {
                        allQueues[queueId] = {
                            queue: data.queue || [],
                            currentCustomer: data.currentCustomer || null,
                            totalServed: data.totalServed || 0,
                            history: data.history || [],
                            lastUpdateTime: data.timestamp || 0
                        };
                    }
                } catch (error) {
                    console.error(`Errore caricamento ${queueId}:`, error);
                }
            }
            
            updateDisplay();
        }

        async function saveQueueToFirebase(queueId, retryCount = 0) {
            if (!isFirebaseReady) {
                console.warn('Firebase non pronto, skip salvataggio');
                return;
            }
            
            const data = {
                queue: allQueues[queueId].queue,
                currentCustomer: allQueues[queueId].currentCustomer,
                totalServed: allQueues[queueId].totalServed,
                history: allQueues[queueId].history,
                timestamp: Date.now(),
                sessionId: sessionId
            };
            
            try {
                const queueRef = window.firebaseRef(window.firebaseDb, `queues/${queueId}`);
                await window.firebaseSet(queueRef, data);
                
                allQueues[queueId].lastUpdateTime = data.timestamp;
                updateSyncIndicator('üî• Salvato in Firebase', 'green');
                
            } catch (error) {
                console.error(`Errore salvataggio Firebase ${queueId}:`, error);
                
                // Retry con backoff esponenziale
                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    updateSyncIndicator(`üîÑ Riprovo... (${retryCount + 1}/3)`, 'yellow');
                    showNotification(`Riprovo salvataggio... (${retryCount + 1}/3)`, 'warning');
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return saveQueueToFirebase(queueId, retryCount + 1);
                } else {
                    updateSyncIndicator('‚ùå Sincronizzazione fallita', 'red');
                    showNotification('Impossibile sincronizzare. Controlla la connessione.', 'error');
                }
            }
        }

        // ========== LOCAL STORAGE BACKUP ==========

        function saveQueueLocal(queueId) {
            const data = {
                ...allQueues[queueId],
                timestamp: Date.now(),
                sessionId: sessionId
            };
            
            try {
                localStorage.setItem(`queue_${queueId}`, JSON.stringify(data));
            } catch (e) {
                console.warn('Errore salvataggio locale:', e);
            }
        }

        async function saveQueueData(queueId) {
            // Salva sempre in locale come backup
            saveQueueLocal(queueId);
            
            // Salva su Firebase se disponibile
            if (isFirebaseReady) {
                await saveQueueToFirebase(queueId);
            }
        }

        // ========== UI FUNCTIONS ==========

        function switchQueue() {
            currentQueueId = document.getElementById('queueSelector').value;
            updateDisplay();
        }
        
        function switchQueueFromControls() {
            currentQueueId = document.getElementById('controlsQueueSelector').value;
            updateDisplay();
        }

        function switchMode() {
            currentMode = document.getElementById('modeSelector').value;
            
            document.getElementById('displayMode').classList.add('hidden');
            document.getElementById('controlsMode').classList.add('hidden');
            document.getElementById('statusMode').classList.add('hidden');
            document.getElementById('overviewMode').classList.add('hidden');
            
            const syncIndicator = document.getElementById('syncIndicator');
            
            switch(currentMode) {
                case 'display':
                    document.getElementById('displayMode').classList.remove('hidden');
                    syncIndicator.classList.add('hidden');
                    break;
                case 'controls':
                    document.getElementById('controlsMode').classList.remove('hidden');
                    syncIndicator.classList.remove('hidden');
                    break;
                case 'status':
                    document.getElementById('statusMode').classList.remove('hidden');
                    syncIndicator.classList.remove('hidden');
                    break;
                case 'overview':
                    document.getElementById('overviewMode').classList.remove('hidden');
                    syncIndicator.classList.remove('hidden');
                    break;
            }
            
            updateDisplay();
        }

        function updateDisplay() {
            const config = QUEUE_CONFIGS[currentQueueId];
            const queueData = allQueues[currentQueueId];
            
            // Display pubblico
            const currentNum = document.getElementById('displayCurrentNumber');
            if (currentNum) {
                if (queueData.currentCustomer) {
                    currentNum.textContent = queueData.currentCustomer.number;
                    currentNum.className = 'number-display font-black text-gray-900';
                } else {
                    currentNum.textContent = '--';
                    currentNum.className = 'number-display font-black text-gray-400';
                }
            }
            
            // Controlli
            if (document.getElementById('controlsQueueName')) {
                document.getElementById('controlsQueueName').textContent = config.name;
                document.getElementById('controlsQueueIcon').textContent = config.icon;
                
                const controlsSelector = document.getElementById('controlsQueueSelector');
                if (controlsSelector) {
                    controlsSelector.value = currentQueueId;
                }
                
                const btn = document.getElementById('controlsCallNextBtn');
                if (queueData.queue.length === 0) {
                    btn.innerHTML = 'üîÑ RIAVVIA<br>CODA (1-99)';
                    btn.className = 'bg-orange-600 hover:bg-orange-700 text-white py-20 rounded-3xl font-black text-5xl transition-all shadow-2xl';
                } else {
                    btn.innerHTML = 'üì¢ CHIAMA<br>PROSSIMO';
                    btn.className = 'bg-green-600 hover:bg-green-700 text-white py-20 rounded-3xl font-black text-5xl transition-all shadow-2xl';
                }
            }
            
            // Stato
            if (document.getElementById('statusQueueName')) {
                document.getElementById('statusQueueName').textContent = config.name;
                document.getElementById('statusQueueIcon').textContent = config.icon;
                
                const queueSelector = document.getElementById('queueSelector');
                if (queueSelector) {
                    queueSelector.value = currentQueueId;
                }
                
                document.getElementById('statusTotalInQueue').textContent = queueData.queue.length;
                document.getElementById('statusTotalServed').textContent = queueData.totalServed;
                
                const estimatedMinutes = queueData.queue.length * 3;
                const wait = document.getElementById('statusEstimatedWait');
                if (estimatedMinutes < 60) {
                    wait.textContent = `~${estimatedMinutes} min`;
                } else {
                    const hours = Math.floor(estimatedMinutes / 60);
                    const mins = estimatedMinutes % 60;
                    wait.textContent = `~${hours}h ${mins}min`;
                }
                
                const currentCust = document.getElementById('statusCurrentCustomer');
                if (queueData.currentCustomer) {
                    currentCust.innerHTML = `
                        <div class="text-4xl font-bold text-yellow-300">#${queueData.currentCustomer.number}</div>
                        <div class="text-sm text-yellow-200 mt-2">Chiamato alle ${queueData.currentCustomer.calledTime}</div>
                    `;
                } else {
                    currentCust.innerHTML = '<div class="text-white/70">Nessun numero chiamato</div>';
                }
                
                document.getElementById('statusNextNumberValue').textContent = 
                    queueData.queue.length > 0 ? queueData.queue[0].number : '--';
                
                const historyList = document.getElementById('statusHistoryList');
                if (queueData.history.length === 0) {
                    historyList.innerHTML = '<div class="text-white/50 text-center py-4">Nessuna attivit√†</div>';
                } else {
                    historyList.innerHTML = queueData.history.slice(-5).reverse().map(item => `
                        <div class="bg-white/10 rounded-lg p-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-white">${item.action}</span>
                                <span class="text-white/50">${item.time}</span>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            // Panoramica
            if (currentMode === 'overview') {
                updateOverview();
            }
        }

        function updateOverview() {
            const grid = document.getElementById('overviewGrid');
            let totalWaiting = 0;
            let totalServed = 0;
            
            grid.innerHTML = Object.keys(QUEUE_CONFIGS).map(queueId => {
                const config = QUEUE_CONFIGS[queueId];
                const data = allQueues[queueId];
                totalWaiting += data.queue.length;
                totalServed += data.totalServed;
                
                return `
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6">
                        <div class="text-center mb-4">
                            <div class="text-5xl mb-2">${config.icon}</div>
                            <h3 class="text-xl font-bold text-white">${config.name}</h3>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="bg-yellow-500/20 rounded-lg p-3 text-center">
                                <div class="text-3xl font-bold text-yellow-300">
                                    ${data.currentCustomer ? data.currentCustomer.number : '--'}
                                </div>
                                <div class="text-xs text-yellow-200">In Servizio</div>
                            </div>
                            
                            <div class="bg-blue-500/20 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-200 text-sm">In Coda</span>
                                    <span class="text-xl font-bold text-blue-300">${data.queue.length}</span>
                                </div>
                            </div>
                            
                            <div class="bg-green-500/20 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-green-200 text-sm">Serviti</span>
                                    <span class="text-xl font-bold text-green-300">${data.totalServed}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('overviewTotalWaiting').textContent = totalWaiting;
            document.getElementById('overviewTotalServed').textContent = totalServed;
        }

        // ========== QUEUE OPERATIONS ==========

        async function callNext() {
            const queueData = allQueues[currentQueueId];
            
            if (queueData.queue.length === 0) {
                restartCurrentQueue();
                setTimeout(() => callNext(), 100);
                return;
            }
            
            if (queueData.currentCustomer) {
                queueData.history.push({
                    action: `‚è≠Ô∏è Numero ${queueData.currentCustomer.number} saltato`,
                    time: new Date().toLocaleTimeString('it-IT')
                });
            }
            
            queueData.currentCustomer = queueData.queue.shift();
            queueData.currentCustomer.calledTime = new Date().toLocaleTimeString('it-IT');
            queueData.totalServed++;
            
            queueData.history.push({
                action: `üì¢ Numero ${queueData.currentCustomer.number} chiamato`,
                time: new Date().toLocaleTimeString('it-IT')
            });
            
            updateDisplay();
            await saveQueueData(currentQueueId);
            showNotification(`Numero ${queueData.currentCustomer.number} chiamato!`, 'success');
        }

        async function goBackOne() {
            const queueData = allQueues[currentQueueId];
            
            if (!queueData.currentCustomer) {
                showNotification('Nessun numero in servizio!', 'error');
                return;
            }
            
            const currentNumber = queueData.currentCustomer.number;
            const previousNumber = currentNumber - 1;
            
            if (previousNumber < 1) {
                showNotification('Non puoi tornare indietro dal numero 1!', 'error');
                return;
            }
            
            queueData.queue.unshift(queueData.currentCustomer);
            
            queueData.currentCustomer = {
                number: previousNumber,
                addedTime: new Date().toLocaleTimeString('it-IT'),
                calledTime: new Date().toLocaleTimeString('it-IT')
            };
            
            queueData.history.push({
                action: `‚¨ÖÔ∏è Tornato al numero ${previousNumber}`,
                time: new Date().toLocaleTimeString('it-IT')
            });
            
            updateDisplay();
            await saveQueueData(currentQueueId);
            showNotification(`Tornato al numero ${previousNumber}!`, 'success');
        }

        async function callSpecificNumber() {
            const input = document.getElementById('specificNumber');
            const numberToCall = parseInt(input.value);
            const queueData = allQueues[currentQueueId];
            
            if (!numberToCall || numberToCall < 1) {
                showNotification('Inserisci un numero valido!', 'error');
                return;
            }
            
            const customerIndex = queueData.queue.findIndex(c => c.number === numberToCall);
            
            if (customerIndex === -1) {
                showNotification(`Numero ${numberToCall} non in coda!`, 'error');
                return;
            }
            
            if (queueData.currentCustomer) {
                queueData.history.push({
                    action: `‚è≠Ô∏è Numero ${queueData.currentCustomer.number} saltato`,
                    time: new Date().toLocaleTimeString('it-IT')
                });
            }
            
            const customer = queueData.queue.splice(customerIndex, 1)[0];
            customer.calledTime = new Date().toLocaleTimeString('it-IT');
            queueData.currentCustomer = customer;
            queueData.totalServed++;
            
            const numbersToRemove = queueData.queue.filter(c => c.number < numberToCall);
            queueData.queue = queueData.queue.filter(c => c.number > numberToCall);
            
            queueData.history.push({
                action: `üéØ Numero ${numberToCall} chiamato - ${numbersToRemove.length} numeri saltati`,
                time: new Date().toLocaleTimeString('it-IT')
            });
            
            input.value = '';
            updateDisplay();
            await saveQueueData(currentQueueId);
            showNotification(`Numero ${numberToCall} chiamato!`, 'success');
        }

        async function restartCurrentQueue() {
            const queueData = allQueues[currentQueueId];
            queueData.queue = [];
            
            for (let i = 1; i <= 99; i++) {
                queueData.queue.push({
                    number: i,
                    addedTime: new Date().toLocaleTimeString('it-IT')
                });
            }
            
            queueData.history.push({
                action: 'üîÑ Coda riavviata - 99 persone in attesa',
                time: new Date().toLocaleTimeString('it-IT')
            });
            
            updateDisplay();
            await saveQueueData(currentQueueId);
            showNotification('Coda riavviata!', 'success');
        }

        async function resetCurrentQueue() {
            const config = QUEUE_CONFIGS[currentQueueId];
            const queueData = allQueues[currentQueueId];
            
            queueData.currentCustomer = null;
            queueData.totalServed = 0;
            queueData.queue = [];
            queueData.history = [];
            
            for (let i = 1; i <= 99; i++) {
                queueData.queue.push({
                    number: i,
                    addedTime: new Date().toLocaleTimeString('it-IT')
                });
            }
            
            queueData.history.push({
                action: `üîÑ ${config.name} resettato completamente`,
                time: new Date().toLocaleTimeString('it-IT')
            });
            
            updateDisplay();
            await saveQueueData(currentQueueId);
            showNotification(`${config.name} resettato!`, 'success');
        }

        async function resetAllQueues() {
            for (const queueId of Object.keys(QUEUE_CONFIGS)) {
                const config = QUEUE_CONFIGS[queueId];
                const queueData = allQueues[queueId];
                
                queueData.currentCustomer = null;
                queueData.totalServed = 0;
                queueData.queue = [];
                queueData.history = [];
                
                for (let i = 1; i <= 99; i++) {
                    queueData.queue.push({
                        number: i,
                        addedTime: new Date().toLocaleTimeString('it-IT')
                    });
                }
                
                queueData.history.push({
                    action: `üîÑ ${config.name} resettato`,
                    time: new Date().toLocaleTimeString('it-IT')
                });
                
                await saveQueueData(queueId);
            }
            
            updateDisplay();
            showNotification('Tutte le code resettate!', 'success');
        }

        // ========== EVENT LISTENERS ==========

        document.addEventListener('DOMContentLoaded', function() {
            const specificNumberInput = document.getElementById('specificNumber');
            if (specificNumberInput) {
                specificNumberInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') callSpecificNumber();
                });
            }
        });

        // ========== INITIALIZATION ==========

        initializeAllQueues();
        updateDisplay();
        
        // Inizializza Firebase
        initializeFirebase();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a1f4d69b44aed22',t:'MTc2MzcxODgzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
